<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Bilanciatore incontri</title>
<script>

function sommaele(myArr, indI, indF) {
	let s = 0
	for(let i = indI; i <= indF; i++) {
		s = s + myArr[i]
	}
	return s
}

function prob(dadi,facce,risult){
	let P1 = []
	let i
	let k
	
	for ( i = 0; i < facce; i++) {
    P1[i] = 0
  }
	for (i = facce; i < 2 * facce; i++) {
    P1[i] = 1
  }
	for (i = 2 * facce; i < (dadi + 1) * facce; i++) {
    P1[i] = 0
  }
	let Pold = []
	let Pt = P1.slice(0)
	
	for (k = 2; k <= dadi; k++) {
		Pold = Pt.slice(0);
		for (i = 0; i < facce; i++) {
      Pt[i] = 0
    }
		for (i = facce; i < (dadi + 1) * facce; i++) {
      Pt[i] = sommaele(Pold, i - facce, i - 1)
    }
	}
	
	for (i = 0; i < Pt.length; i++) {
    Pt[i] = Pt[i] / Math.pow(facce, dadi)
  }
	for (i = 0; i < facce; i++) {
    Pt.shift()
  }
	
	//console.log("P1: ", P1);
	//console.log("Pold: ", Pold);
	//console.log("Pt: ",Pt);
	//console.log("La prob. di tirare **",risult,"** Ã¨ del ",(Pt[risult-1]*100).toFixed(2),"%");
	return Pt[risult-1]
}

function cumul(dadi, facce, risult) {
	let somma = 0
	for (let i = 1; i <= risult; i++) {
		somma += prob(dadi, facce, i)
	}
	
	return somma
}

function lower(id, minimo) {
  id.innerHTML = Math.max(parseInt(id.innerHTML) - 1, minimo)
  run()
}
function raise(id, massimo) {
  id.innerHTML = Math.min(parseInt(id.innerHTML) + 1, massimo)
  run()
}

function getValue(name) {
  return document.getElementById(name).innerHTML
}

function setValue(name, value) {
  return document.getElementById(name).innerHTML = value
}

function run() {
  let critS=0;
  let atk = +(getValue("atk"))
  let dmgD = +(getValue("dmgD"))
  let dmgM = +(getValue("dmgM"))
  let def = +(getValue("def"))
  let DR = +(getValue("DR"))

  if (atk >= 16) {
    critS = 6
  } else if (atk == 15) {
    critS = 5
  } else {
    critS = 4
  }

  let pConn = cumul(3, 6, critS) + (cumul(3, 6, Math.min(Math.max(atk, 4), 16)) - cumul(3, 6, critS)) * (1 - cumul(3, 6, Math.min(Math.max(def, 4), 16)))
  let pDanno = 1 - cumul(dmgD, 6, Math.min(dmgD*6, DR - dmgM))
  let pEffect = pConn * pDanno
 

  setValue("ode", (Math.abs(pConn)   *100).toFixed(2))
  setValue("odr", (Math.abs(pDanno)  *100).toFixed(2))
  setValue("ctd", (Math.abs(pEffect) *100).toFixed(2))
}

</script>

<style>

table {	
	border: 2px solid black;
	width: 100%;
	max-width: 400px;
}

.righe {
	height: 3em;
}

.nome {
	width: 8em;
}		

.meno, .piu {
	width: 3em;
	text-align:center;
}
.val {
	width: 4em;
	text-align: center;
}
</style>
</head>
<body>
  <table>
  	<tr>
  		<td colspan="4"><p style="text-align:center; border: 1px solid black;">Attacker</p></td>
  	</tr>
  	<tr class="righe">
  		<td class="nome">Attack skill</td>
  		<td class="meno"><button type="button" onclick="lower(atk, 0)">-</td>
  		<td class="val"><span id="atk">10</span></td>
  		<td class="piu"><button type="button" onclick="raise(atk, 20)">+</td>		
  	</tr>
  	<tr class="righe">
  		<td class="nome">Attack dice</td>
  		<td class="meno"><button type="button" onclick="lower(dmgD, 1)">-</td>
  		<td class="val"><span id="dmgD">2</span></td>
  		<td class="piu"><button type="button" onclick="raise(dmgD, 100)">+</td>		
  	</tr>
  	<tr class="righe">
  		<td class="nome">Attack modifier</td>
  		<td class="meno"><button type="button" onclick="lower(dmgM, -6)">-</td>
  		<td class="val"><span id="dmgM">1</span></td>
  		<td class="piu"><button type="button" onclick="raise(dmgM, 4)">+</td>		
  	</tr>
  	<tr style="height:1em;">
  	</tr>
  	<tr>
  		<td colspan="4"><p style="text-align:center; border: 1px solid black;">Defender</p></td>
  	</tr>	
  	<tr class="righe">
  		<td class="nome">Defense skill</td>
  		<td class="meno"><button type="button" onclick="lower(def, 0)">-</td>
  		<td class="val"><span id="def">10</span></td>
  		<td class="piu"><button type="button" onclick="raise(def, 20)">+</td>		
  	</tr>
  	<tr class="righe">
  		<td class="nome">Armor DR</td>
  		<td class="meno"><button type="button" onclick="lower(DR, 0)">-</td>
  		<td class="val"><span id="DR">2</span></td>
  		<td class="piu"><button type="button" onclick="raise(DR, 20)">+</td>		
  	</tr>	
  </table>
  <p><span>Overcome defense:</span> <span id="ode"></span> %</p>
  <p><span>Overcome DR:</span>      <span id="odr"></span> %</p>
  <p><span>Chance to damage:</span> <span id="ctd"></span> %</p>
</body>
</html>
